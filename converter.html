<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Конвертер криптовалют</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Небольшие встроенные стили (совместимы с твоим style.css) */
    :root { --radius: 12px; --card-w: 760px; }
    main { padding: 32px; display:flex; justify-content:center; }
    .card {
      width: 100%; max-width: var(--card-w);
      background:#fff; border-radius:var(--radius);
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
      padding: 22px; box-sizing:border-box;
    }
    h1 { margin:0 0 18px 0; text-align:center; font-size:20px; }
    .form-row { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; align-items:center; }
    select, input[type="number"] {
      padding:10px; border-radius:10px; border:1px solid #ddd; font-size:15px;
    }
    .amount { width:160px; }
    .select { width:180px; }
    button {
      padding:12px 20px; background:#000; color:#fff; border:none; border-radius:12px; cursor:pointer;
    }
    .result {
      margin-top:18px; text-align:center; font-size:16px;
    }
    .meta { margin-top:8px; color:#666; text-align:center; font-size:13px; }
    .error { color:#b00020; text-align:center; margin-top:8px; }
    @media(max-width:720px){ .form-row { flex-direction:column; } .select{width:100%} .amount{width:100%} }
  </style>
</head>
<body>
  <header>
    <a href="https://www.binance.com/ru?ref=SITES" target="_blank">Купите криптовалюту и торгуйте на BINANCE</a>
  </header>

  <nav>
    <ul>
      <li><a href="index.html">Калькулятор</a></li>
      <li><a href="crypto-index.html">Индекс Топ 500 криптовалют</a></li>
      <li><a href="minipc.html">Мини ПК для трейдинга</a></li>
      <li><a href="converter.html">Конвертер криптовалют</a></li>
    </ul>
  </nav>

  <!-- (если у тебя используется corner-cut, держи див; иначе можно удалить) -->
  <div class="corner-cut" style="display:none;"></div>

  <main>
    <div class="card" role="application" aria-label="Конвертер криптовалют">
      <h1>Конвертер криптовалют</h1>

      <div class="form-row" style="margin-bottom:12px;">
        <input class="amount" id="amount" type="number" min="0" step="any" value="1" aria-label="Количество">
        <select id="from" class="select" aria-label="Из валюты"></select>
        <span style="align-self:center;">→</span>
        <select id="to" class="select" aria-label="В валюту"></select>
        <button id="convertBtn">Конвертировать</button>
      </div>

      <div class="result" id="result">Результат: —</div>
      <div class="meta" id="meta">Курс: — · Обновлено: —</div>
      <div class="error" id="error" role="alert" aria-live="assertive"></div>
    </div>
  </main>

<script>
/*
  Конвертер использует CoinGecko simple/price endpoint:
  https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd
  (Документация: https://www.coingecko.com/en/api) — см. примечания внизу.
  Кэшируем полученные курсы на 60 сек, чтобы снизить количество запросов.
*/

const coinMap = {
  "bitcoin":"Bitcoin (BTC)",
  "ethereum":"Ethereum (ETH)",
  "binancecoin":"BNB",
  "tether":"Tether (USDT)",
  "cardano":"Cardano (ADA)",
  "ripple":"XRP",
  "dogecoin":"Dogecoin (DOGE)",
  "solana":"Solana (SOL)",
  "litecoin":"Litecoin (LTC)",
  "polkadot":"Polkadot (DOT)"
};

const fiatList = ["usd","eur","rub","uah","gbp"];

const fromSelect = document.getElementById('from');
const toSelect = document.getElementById('to');
const amountEl = document.getElementById('amount');
const resultEl = document.getElementById('result');
const metaEl = document.getElementById('meta');
const errorEl = document.getElementById('error');
const btn = document.getElementById('convertBtn');

// Соберём опции: крипто + фиат (фиат - через ids "usd" в vs_currencies)
function buildOptions(){
  // сначала криптовалюты
  for(const id of Object.keys(coinMap)){
    const opt = document.createElement('option');
    opt.value = id;
    opt.textContent = coinMap[id];
    fromSelect.appendChild(opt.cloneNode(true));
    toSelect.appendChild(opt.cloneNode(true));
  }
  // затем фиат как "usd" и т.д. пометим value как фиат:usd
  for(const f of fiatList){
    const opt1 = document.createElement('option');
    opt1.value = 'fiat:' + f;
    opt1.textContent = f.toUpperCase();
    fromSelect.appendChild(opt1);
    toSelect.appendChild(opt1.cloneNode(true));
  }
  // по умолчанию: BTC → USD
  fromSelect.value = 'bitcoin';
  toSelect.value = 'fiat:usd';
}
buildOptions();

// Простой кеш: { key: {ts, data} }, key = ids|vs
const cache = {};
const CACHE_TTL = 60 * 1000; // 60 сек

async function fetchPrices(idsArr, vsArr){
  // idsArr = ['bitcoin','ethereum'], vsArr = ['usd','eur']
  const ids = idsArr.join(',');
  const vs = vsArr.join(',');
  const key = ids + '|' + vs;
  const now = Date.now();
  if(cache[key] && (now - cache[key].ts) < CACHE_TTL) {
    return cache[key].data;
  }

  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=${encodeURIComponent(vs)}`;
  try {
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json();
    cache[key] = { ts: now, data };
    return data;
  } catch (e) {
    throw e;
  }
}

function parseValue(val){
  const n = Number(val);
  return (isNaN(n) ? 0 : n);
}

async function doConvert(){
  errorEl.textContent = '';
  const rawFrom = fromSelect.value;
  const rawTo = toSelect.value;
  const amount = parseValue(amountEl.value);
  if(amount <= 0) {
    resultEl.textContent = 'Результат: введите положительное значение';
    return;
  }
  // determine types
  const fromIsFiat = rawFrom.startsWith('fiat:');
  const toIsFiat = rawTo.startsWith('fiat:');

  try {
    // Case:
    // 1) crypto -> crypto: need price of both vs same fiat (usd) OR compute cross via usd
    // 2) crypto -> fiat: need price of crypto in that fiat
    // 3) fiat -> crypto: need inverse

    // Choose a common reference fiat for cross rates (usd)
    const refFiat = 'usd';

    if(!fromIsFiat && !toIsFiat){
      // crypto -> crypto
      const fromId = rawFrom;
      const toId = rawTo;
      // fetch both prices in refFiat
      const data = await fetchPrices([fromId, toId], [refFiat]);
      const fromPrice = data[fromId] && data[fromId][refFiat];
      const toPrice = data[toId] && data[toId][refFiat];
      if(fromPrice == null || toPrice == null) throw new Error('Не удалось получить цену');
      const valueInTo = (amount * fromPrice) / toPrice;
      resultEl.textContent = `Результат: ${valueInTo} ${coinMap[toId] || toId}`;
      metaEl.textContent = `Курс: 1 ${coinMap[fromId] || fromId} = ${(fromPrice / toPrice).toFixed(8)} ${coinMap[toId] || toId} · обновлено: сейчас`;
    } else if(!fromIsFiat && toIsFiat){
      // crypto -> fiat
      const fromId = rawFrom;
      const toFiat = rawTo.split(':')[1];
      const data = await fetchPrices([fromId], [toFiat]);
      const price = data[fromId] && data[fromId][toFiat];
      if(price == null) throw new Error('Не удалось получить цену');
      const value = amount * price;
      resultEl.textContent = `Результат: ${value.toFixed(8)} ${toFiat.toUpperCase()}`;
      metaEl.textContent = `Курс: 1 ${coinMap[fromId] || fromId} = ${price} ${toFiat.toUpperCase()}`;
    } else if(fromIsFiat && !toIsFiat){
      // fiat -> crypto
      const fromFiat = rawFrom.split(':')[1];
      const toId = rawTo;
      const data = await fetchPrices([toId], [fromFiat]);
      const price = data[toId] && data[toId][fromFiat];
      if(price == null) throw new Error('Не удалось получить цену');
      const value = amount / price;
      resultEl.textContent = `Результат: ${value.toFixed(8)} ${coinMap[toId] || toId}`;
      metaEl.textContent = `Курс: 1 ${coinMap[toId] || toId} = ${price} ${fromFiat.toUpperCase()}`;
    } else {
      // fiat -> fiat (e.g. USD -> EUR) — use crypto as bridge (not ideal). We'll fetch btc prices in both and compute ratio
      const f1 = rawFrom.split(':')[1];
      const f2 = rawTo.split(':')[1];
      // use bitcoin as reference
      const data = await fetchPrices(['bitcoin'], [f1, f2]);
      const p1 = data['bitcoin'] && data['bitcoin'][f1];
      const p2 = data['bitcoin'] && data['bitcoin'][f2];
      if(p1 == null || p2 == null) throw new Error('Не удалось получить цены для фиатов');
      const rate = p1 / p2; // 1 f1 = rate f2
      const val = amount * rate;
      resultEl.textContent = `Результат: ${val.toFixed(8)} ${f2.toUpperCase()}`;
      metaEl.textContent = `Курс: 1 ${f1.toUpperCase()} = ${rate.toFixed(8)} ${f2.toUpperCase()}`;
    }
  } catch (err){
    console.error(err);
    errorEl.textContent = 'Ошибка получения курса — попробуйте позже.';
  }
}

btn.addEventListener('click', (e) => {
  e.preventDefault();
  doConvert();
});
</script>

<!-- Подсказка про API (ссылка на документацию) -->
<!-- Источник данных: CoinGecko /simple/price. Внимание: у API есть лимиты по количеству запросов; кеширование встроено. -->
</body>
</html>
