<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö—Ä–∏–ø—Ç–æ –Ω–æ–≤–æ—Å—Ç–∏ (RSS –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    main { margin-left: 250px; margin-top: 64px; padding: 20px; }
    h1 { text-align: center; margin-bottom: 18px; }
    .news-list { max-width: 980px; margin: 0 auto; display:flex; flex-direction:column; gap:14px; }
    .news-item { background:#fff; border-radius:10px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .news-item h3 { margin:0 0 6px 0; font-size:18px; }
    .news-item a { color:#007bff; text-decoration:none; }
    .news-item a:hover { text-decoration:underline; }
    .meta { font-size:13px; color:#666; margin-bottom:6px; }
    .summary { color:#333; font-size:14px; }
    .loading { text-align:center; padding:30px; color:#444; }
    .controls { text-align:center; margin-bottom:12px; }
    .small { font-size:13px; color:#666; }
  </style>
</head>
<body>
  <div id="header"></div>
  <div id="sidebar"></div>

  <main>
    <h1>üì∞ –ê–≥–≥—Ä–µ–≥–∞—Ç–æ—Ä –∫—Ä–∏–ø—Ç–æ‚Äë–Ω–æ–≤–æ—Å—Ç–µ–π (RSS)</h1>

    <div class="controls">
      <button id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
      <span class="small"> | –ò—Å—Ç–æ—á–Ω–∏–∫–∏: CoinDesk, CoinTelegraph, Decrypt, CryptoSlate, TheBlock –∏ –¥—Ä.</span>
    </div>

    <div id="news-container" class="news-list">
      <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
    </div>
  </main>

  <script>
  // –ü–æ–¥–≥—Ä—É–∂–∞–µ–º header –∏ sidebar (–∫–∞–∫ —É –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü)
  fetch('header.html').then(r => r.text()).then(t => document.getElementById('header').innerHTML = t);
  fetch('sidebar.html').then(r => r.text()).then(t => document.getElementById('sidebar').innerHTML = t);

  const newsContainer = document.getElementById('news-container');
  const refreshBtn = document.getElementById('refreshBtn');

  // –°–ø–∏—Å–æ–∫ RSS-–ª–µ–Ω—Ç (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å/–º–µ–Ω—è—Ç—å)
  const feeds = [
    'https://www.coindesk.com/arc/outboundfeeds/rss/',               // CoinDesk
    'https://cointelegraph.com/rss',                                // CoinTelegraph
    'https://decrypt.co/feed',                                      // Decrypt
    'https://cryptoslate.com/feed/',                                // CryptoSlate
    'https://www.theblock.co/feed',                                 // The Block
    'https://www.coingecko.com/en/rss',                             // CoinGecko (–Ω–æ–≤–æ—Å—Ç–∏)
    'https://news.bitcoin.com/feed/'                                // Bitcoin.com
  ];

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º allorigins raw endpoint ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä–æ–π —Ç–µ–∫—Å—Ç (–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç CORS)
  function proxyUrl(url) {
    return 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
  }

  // –ü–∞—Ä—Å–∏–º –æ–¥–Ω—É RSS-–ª–µ–Ω—Ç—É -> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ {title, link, pubDate (Date), source, summary}
  async function fetchAndParse(feedUrl) {
    try {
      const res = await fetch(proxyUrl(feedUrl));
      if (!res.ok) throw new Error('fetch failed ' + res.status);
      const text = await res.text();
      const doc = new DOMParser().parseFromString(text, 'application/xml');

      // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
      let source = '';
      const chTitle = doc.querySelector('channel > title');
      if (chTitle) source = chTitle.textContent.trim();
      if (!source) {
        const feedTitle = doc.querySelector('feed > title');
        if (feedTitle) source = feedTitle.textContent.trim();
      }
      // –í—ã–±–µ—Ä–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã item –∏–ª–∏ entry
      const items = Array.from(doc.querySelectorAll('item, entry')).slice(0, 50);
      const parsed = items.map(it => {
        // title
        const tEl = it.querySelector('title');
        const title = tEl ? tEl.textContent.trim() : '(–±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞)';

        // link
        let link = '';
        const linkEl = it.querySelector('link');
        if (linkEl) {
          // –≤ Atom <link href="...">
          link = linkEl.getAttribute('href') || linkEl.textContent || '';
        }
        // –≤–æ–∑–º–æ–∂–Ω–æ –µ—Å—Ç—å <enclosure> –∏–ª–∏ <guid>
        if (!link) {
          const guid = it.querySelector('guid');
          if (guid) link = guid.textContent || '';
        }

        // pubDate / updated / published
        let dateStr = '';
        const dateEl = it.querySelector('pubDate, published, updated, dc\\:date');
        if (dateEl) dateStr = dateEl.textContent;
        const pubDate = dateStr ? new Date(dateStr) : null;

        // description / summary
        const descEl = it.querySelector('description, summary, content');
        const summary = descEl ? descEl.textContent.trim() : '';

        return {
          title,
          link: link || '',
          pubDate,
          source: source || feedUrl,
          summary
        };
      });
      return parsed;
    } catch (e) {
      console.warn('feed error', feedUrl, e);
      return []; // –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    }
  }

  // –°–æ–±–∏—Ä–∞–µ–º —Å—Ä–∞–∑—É –∏–∑ –≤—Å–µ—Ö —Ñ–∏–¥–æ–≤
  async function loadAllNews() {
    newsContainer.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>';

    try {
      const promises = feeds.map(f => fetchAndParse(f));
      const arrays = await Promise.all(promises);
      // flatten
      let all = arrays.flat();

      // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å —Å—Å—ã–ª–∫–æ–π –∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
      all = all.filter(it => it.title && it.link);

      // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ —Å—Å—ã–ª–∫–µ
      const unique = [];
      const urls = new Set();
      for (const it of all) {
        if (!urls.has(it.link)) {
          urls.add(it.link);
          unique.push(it);
        }
      }

      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç ‚Äî –ø–æ—Å—Ç–∞–≤–∏–º –æ—á–µ–Ω—å —Å—Ç–∞—Ä—É—é –¥–∞—Ç—É, –ø–æ—Ç–æ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –Ω–∞–ª–∏—á–∏—é –¥–∞—Ç—ã –∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é
      unique.forEach(it => {
        if (!it.pubDate || isNaN(it.pubDate)) {
          it.pubDate = new Date(0);
        }
      });

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–≤—ã–º–∏)
      unique.sort((a, b) => b.pubDate - a.pubDate);

      if (unique.length === 0) {
        newsContainer.innerHTML = '<div class="loading">–ù–æ–≤–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ üòî</div>';
        return;
      }

      // –†–µ–Ω–¥–µ—Ä–∏–º top N
      const top = unique.slice(0, 30);
      newsContainer.innerHTML = top.map(it => {
        const dateText = (it.pubDate && it.pubDate.getTime() > 0)
          ? it.pubDate.toLocaleString('ru-RU')
          : '';
        const summaryShort = it.summary ? ('<div class="summary">' + escapeHtml(truncate(stripTags(it.summary), 280)) + '</div>') : '';
        return `
          <div class="news-item">
            <div class="meta">${escapeHtml(it.source)} ${dateText ? '| ' + dateText : ''}</div>
            <h3><a href="${escapeHtmlAttr(it.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(it.title)}</a></h3>
            ${summaryShort}
          </div>
        `;
      }).join('');

    } catch (e) {
      console.error(e);
      newsContainer.innerHTML = '<div class="loading">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ üòî</div>';
    }
  }

  // –£—Ç–∏–ª–∏—Ç—ã
  function stripTags(html) {
    return html.replace(/<\/?[^>]+(>|$)/g, " ");
  }
  function truncate(str, n) {
    return str.length > n ? str.slice(0, n-1) + '‚Ä¶' : str;
  }
  function escapeHtml(s) {
    return (s||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])});
  }
  function escapeHtmlAttr(s) {
    return escapeHtml(s).replace(/"/g, '&quot;');
  }

  // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å
  refreshBtn.addEventListener('click', () => {
    loadAllNews();
  });

  // –ì—Ä—É–∑–∏–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  loadAllNews();

  </script>
</body>
</html>
