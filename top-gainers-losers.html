<script>
  // Header & sidebar
  fetch('header.html')
    .then(res => res.text())
    .then(data => document.getElementById('header').innerHTML = data);

  fetch('sidebar.html')
    .then(res => res.text())
    .then(data => document.getElementById('sidebar').innerHTML = data);

  const REF_ID = 'SITES';
  const COINGECKO_API =
    'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&price_change_percentage=24h';

  // Соответствие ID CoinGecko → тикеру Binance
  const coinToSymbol = {
    bitcoin: 'BTC',
    ethereum: 'ETH',
    binancecoin: 'BNB',
    ripple: 'XRP',
    solana: 'SOL',
    dogecoin: 'DOGE',
    cardano: 'ADA',
    avalanche: 'AVAX',
    toncoin: 'TON',
    chainlink: 'LINK',
    polygon: 'MATIC',
    polkadot: 'DOT',
    tron: 'TRX',
    litecoin: 'LTC',
    near: 'NEAR',
    internet_computer: 'ICP',
    uniswap: 'UNI',
    aptos: 'APT',
    cosmos: 'ATOM',
    filecoin: 'FIL'
  };

  async function loadData() {
    try {
      const res = await fetch(COINGECKO_API);
      const data = await res.json();

      const filtered = data
        .filter(c => coinToSymbol[c.id])
        .map(c => ({
          base: coinToSymbol[c.id],
          price: c.current_price,
          change: c.price_change_percentage_24h
        }));

      const gainers = [...filtered].sort((a, b) => b.change - a.change).slice(0, 10);
      const losers = [...filtered].sort((a, b) => a.change - b.change).slice(0, 10);

      renderTable('gainers-spot', gainers, 'spot');
      renderTable('losers-spot', losers, 'spot');
      renderTable('gainers-futures', gainers, 'futures');
      renderTable('losers-futures', losers, 'futures');
    } catch (e) {
      console.error('Ошибка загрузки данных CoinGecko:', e);
    }
  }

  function renderTable(id, arr, type) {
    const tbody = document.getElementById(id);
    tbody.innerHTML = '';

    arr.forEach(item => {
      const cls = item.change >= 0 ? 'green' : 'red';
      const url =
        type === 'spot'
          ? `https://www.binance.com/ru/trade/${item.base}_USDT?ref=${REF_ID}`
          : `https://www.binance.com/ru/futures/${item.base}USDT?ref=${REF_ID}`;

      const row = `
        <tr>
          <td>${item.base}/USDT</td>
          <td>${item.price.toFixed(6)}</td>
          <td class="${cls}">${item.change.toFixed(2)}%</td>
          <td><a class="trade-btn" href="${url}" target="_blank">Торговать</a></td>
        </tr>
      `;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  }

  loadData();
  setInterval(loadData, 30000);
</script>
